pipeline {
    agent any

    environment {
        DOCKER_LOGIN = credentials('docker-login')
        IMAGE_REPOSITORY = 'rajatrulaniya/inventory-frontend'
    }

    stages {
        stage('Set Image tags') {
            steps {
                script {
                    env.IMAGE_TAG1 = "v${env.INVENTORY_FRONTEND_MAJOR}.${env.INVENTORY_FRONTEND_MINOR}.${env.BUILD_NUMBER}"

                    env.IMAGE_TAG2 = "${env.GIT_COMMIT}"
                }
            }
        }

        // stage('Update backend-url') {
        //   steps {
        //     dir('frontend') {
        //       sh """
        //         echo REACT_APP_API_BASE_URL=http://${BACKEND_HOST}:${BACKEND_PORT} > .env
        //       """
        //     }
        //   }
        // }

        stage('Build & Test') {
            steps {
                dir('frontend') {
                    sh """
                        docker build -t inventory-frontend-tester --target builder .
                        docker run --rm inventory-frontend-tester npm test -- --watchAll=false || exit 1
                    """
                }
            }
        }

        stage('Image building') {
            steps {
                dir('frontend') {
                    sh """
                        echo "${env.DOCKER_LOGIN_PSW}" | docker login -u "${env.DOCKER_LOGIN_USR}" --password-stdin 

                        docker build \
                            -t ${env.IMAGE_REPOSITORY}:${env.IMAGE_TAG1} \
                            -t ${env.IMAGE_REPOSITORY}:${env.IMAGE_TAG2} .
                    """
                }
            }
        }

        stage('Image Scanning') {
            steps {
                sh """
                    trivy image \
                        --exit-code 1 --severity HIGH,CRITICAL \
                        ${env.IMAGE_REPOSITORY}:${env.IMAGE_TAG1}
                """
            }
        }

        stage('Image Upload & Clean') {
            steps {
                sh """
                    echo "${env.DOCKER_LOGIN_PSW}" | docker login -u "${env.DOCKER_LOGIN_USR}" --password-stdin 

                    docker push ${env.IMAGE_REPOSITORY}:${env.IMAGE_TAG1}

                    docker push ${env.IMAGE_REPOSITORY}:${env.IMAGE_TAG2}

                    echo "Keeping only latest 4 images for frontend; Removing older ones..."

                    docker images ${env.IMAGE_REPOSITORY} --format "{{.ID}} {{.CreatedAt}}" | sort -r -k2 | awk 'NR>4 {print $1}' | sort -u | xargs -r docker rmi -f
                """
            }
        }

        stage('Helm Deploy to EKS') {
          steps {
            sh """
                helm upgrade --install inventory-frontend ./helm-chart/frontend \
                  --set image.tag=${env.IMAGE_TAG1} \
                  --set backend_host=${env.BACKEND_HOST} \
                  --set backend_port=${env.BACKEND_PORT}
            """
          }
        }
    }
}